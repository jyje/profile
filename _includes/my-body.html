{% comment %}
<!--
Example code for using Matamo as alternative analytics solution.
-->
{% if site.matomo_analytics %}
<script>
  var _paq = _paq || [];

  {% if site.matomo_analytics.no_cookies %}
  _paq.push(['disableCookies']);
  {% endif %}

  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['setTrackerUrl', u+'piwik.php']);
  _paq.push(['setSiteId', '{{site.matomo_analytics.site_id}}']);

  var pushStateEl = document.getElementById('_pushState');
  var timeStartLoadPage, referer, timeItTookToLoadPage;

  pushStateEl.addEventListener('hy-push-state-start', function() {
    timeStartLoadPage = new Date().getTime();
    referer = window.location.toString();
  });

  pushStateEl.addEventListener('hy-push-state-ready', function() {
    timeItTookToLoadPage = new Date().getTime() - timeStartLoadPage;
  });

  pushStateEl.addEventListener('hy-push-state-after', function() {
    _paq.push(['setReferrerUrl', referer]);
    _paq.push(['setCustomUrl', window.location.toString()]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['deleteCustomVariables', 'page']);
    _paq.push(['setGenerationTimeMs', timeItTookToLoadPage]);
    _paq.push(['trackPageView']);
  });

  window.loadJSDeferred('{{site.matomo_analytics.root}}piwik.js');
</script>
{% endif %}
{% endcomment %}

<!-- Language switching and sidebar updates -->
<script>
(function() {
  /* Function to convert URL between languages (ko <-> en) */
  function switchLanguageUrl(url, targetLang) {
    var pathname = url;
    if (typeof url === 'string' && url.indexOf('://') !== -1) {
      var urlObj = new URL(url);
      pathname = urlObj.pathname;
    }
    
    if (targetLang === 'ko') {
      /* Convert to Korean URL */
      if (pathname === '/' || pathname === '') {
        return '/ko/';
      }
      /* Replace /en/ with /ko/ or prepend /ko/ if no language prefix */
      if (pathname.indexOf('/en/') === 0) {
        return pathname.replace('/en/', '/ko/');
      } else if (pathname.indexOf('/en') === 0) {
        return pathname.replace('/en', '/ko');
      } else if (pathname.indexOf('/ko/') !== 0 && pathname.indexOf('/ko') !== 0) {
        /* No language prefix, add /ko/ */
        return '/ko' + (pathname.startsWith('/') ? pathname : '/' + pathname);
      }
      return pathname; /* Already Korean */
    } else {
      /* Convert to English URL */
      if (pathname === '/ko/' || pathname === '/ko') {
        return '/';
      }
      /* Replace /ko/ with /en/ or remove /ko/ prefix */
      if (pathname.indexOf('/ko/') === 0) {
        var englishPath = pathname.replace('/ko/', '/en/');
        /* If resulting path is /en/, return / instead */
        return englishPath === '/en/' ? '/' : englishPath;
      } else if (pathname.indexOf('/ko') === 0) {
        var englishPath = pathname.replace('/ko', '/en');
        return englishPath === '/en' ? '/' : englishPath;
      }
      /* Already English or no language prefix */
      if (pathname === '/') {
        return '/';
      }
      /* Add /en/ prefix if needed */
      if (pathname.indexOf('/en/') !== 0 && pathname.indexOf('/en') !== 0) {
        return '/en' + (pathname.startsWith('/') ? pathname : '/' + pathname);
      }
      return pathname;
    }
  }

  /* Save drawer state before page reload */
  function saveDrawerState() {
    var drawer = document.getElementById('_drawer');
    if (drawer) {
      var isOpen = drawer.hasAttribute('opened');
      sessionStorage.setItem('drawerState', isOpen ? 'opened' : 'closed');
    }
  }

  /* Restore drawer state after page load */
  function restoreDrawerState() {
    var drawerState = sessionStorage.getItem('drawerState');
    if (drawerState) {
      var drawer = document.getElementById('_drawer');
      if (drawer) {
        if (drawerState === 'opened' && !drawer.hasAttribute('opened')) {
          drawer.setAttribute('opened', '');
        } else if (drawerState === 'closed' && drawer.hasAttribute('opened')) {
          drawer.removeAttribute('opened');
        }
      }
      sessionStorage.removeItem('drawerState');
    }
  }

  /* Setup language switch links */
  function setupLanguageSwitches() {
    var langEnLink = document.getElementById('lang-en');
    var langKoLink = document.getElementById('lang-ko');
    
    if (langEnLink && langKoLink) {
      var currentPath = window.location.pathname;
      var enUrl = switchLanguageUrl(currentPath, 'en');
      var koUrl = switchLanguageUrl(currentPath, 'ko');
      
      langEnLink.href = enUrl;
      langKoLink.href = koUrl;
      
      /* Force full page reload on language switch to update sidebar */
      langEnLink.addEventListener('click', function(e) {
        e.preventDefault();
        saveDrawerState();
        window.location.href = enUrl;
      });
      
      langKoLink.addEventListener('click', function(e) {
        e.preventDefault();
        saveDrawerState();
        window.location.href = koUrl;
      });
    }
  }

  /* Update language switch links after page navigation */
  var pushStateEl = document.getElementById('_pushState');
  if (pushStateEl) {
    pushStateEl.addEventListener('hy-push-state-after', function() {
      setupLanguageSwitches();
    });
  }

  /* Initial setup */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setupLanguageSwitches();
      restoreDrawerState();
    });
  } else {
    setupLanguageSwitches();
    restoreDrawerState();
  }
})();
</script>
