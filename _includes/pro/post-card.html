{% assign post = include.post %}

{% assign vars = site.data.variables %}
{% assign break_point_1 = vars.break_point_1 | default:42 %}
{% assign break_point_2 = vars.break_point_2 | default:54 %}
{% assign break_point_5 = vars.break_point_5 | default:86 %}
{% assign content_width   = vars.content_width   | default:42 %}
{% assign content_width_2 = vars.content_width_2 | default:48 %}
{% assign content_width_5 = vars.content_width_5 | default:54 %}

{% assign sizes = '' %}
{% if include.featured %}
  {% capture sizes %}(min-width: {{ break_point_5 }}em) {{ content_width_5 | plus:2 }}rem, 
                     (min-width: {{ break_point_2 }}em) {{ content_width_2 | plus:2 }}rem, 
                     (min-width: {{ break_point_1 }}em) {{ content_width   | plus:2 }}rem, 
                                                        {{ content_width            }}rem
  {% endcapture %}
{% else %}
  {% capture sizes %}(min-width: {{ break_point_5 }}em) {{ content_width_5 | plus:2 | divided_by:2 | minus:0.5 }}rem, 
                     (min-width: {{ break_point_2 }}em) {{ content_width_2 | plus:2 | divided_by:2 | minus:0.5 }}rem, 
                     (min-width: {{ break_point_1 }}em) {{ content_width   | plus:2 | divided_by:2 | minus:0.5 }}rem, 
                                                        {{ content_width                                       }}rem
  {% endcapture %}
{% endif %}
{% assign sizes = sizes | strip_newlines %}

{% comment %} Process image properties before rendering {% endcomment %}
{% if post.image %}
  {% comment %} Support both string and object formats for image {% endcomment %}
  {% assign img_obj = post.image %}
  {% comment %} Check if it's an object by trying to access .path - if it fails, it's a string {% endcomment %}
  {% if img_obj.path != nil %}
    {% comment %} It's an object with .path property {% endcomment %}
    {% assign img_path = img_obj.path %}
    {% assign img_width = img_obj.width | default: 864 %}
    {% assign img_height = img_obj.height | default: 486 %}
    {% comment %} left, top for object-position (optional, supports px and %) {% endcomment %}
    {% if img_obj.left != nil or img_obj.top != nil %}
      {% assign img_left = img_obj.left | default: "50%" %}
      {% assign img_top = img_obj.top | default: "50%" %}
      {% comment %} Add % suffix if value is a number without unit {% endcomment %}
      {% assign left_str = img_left | append: "" %}
      {% assign top_str = img_top | append: "" %}
      {% unless left_str contains "%" or left_str contains "px" %}
        {% assign left_str = left_str | append: "%" %}
      {% endunless %}
      {% unless top_str contains "%" or top_str contains "px" %}
        {% assign top_str = top_str | append: "%" %}
      {% endunless %}
      {% capture img_position %}{{ left_str }} {{ top_str }}{% endcapture %}
    {% else %}
      {% assign img_position = nil %}
    {% endif %}
    {% capture container_style %}aspect-ratio: {{ img_width }} / {{ img_height }}; overflow: hidden;{% endcapture %}
  {% else %}
    {% comment %} It's a string {% endcomment %}
    {% assign img_path = post.image %}
    {% assign img_width = 864 %}
    {% assign img_height = 486 %}
    {% assign img_position = nil %}
    {% assign container_style = nil %}
  {% endif %}
{% endif %}

<article class="project-card">
  <a href="{{ post.url | relative_url }}" class="no-hover no-print-link {% unless post.hide_image %}flip-project{% endunless %}" tabindex="-1">
    <div class="project-card-img aspect-ratio {% if post.image %}flip-project-img{% else %}fallback-img{% endif %}" {% if container_style %}style="{{ container_style }}"{% endif %}>
      {% if post.image %}
        {% include_cached components/hy-img.html img=img_path alt=post.title sizes=sizes width=img_width height=img_height position=img_position %}
      {% endif %}
    </div>
  </a>
  <h3 class="project-card-title flip-project-title">
    <a href="{{ post.url | relative_url }}" class="flip-title">{{ post.title }}</a>
  </h3>
  {% if post.description or post.tagline or post.caption %}
    <p class="project-card-text fine" property="disambiguatingDescription">
      {{ post.tagline | default:post.caption | default:post.description | markdownify | replace:'<p>','' | replace:'</p>','' }}
    </p>
  {% endif %}
  {% assign text = site.data.strings.continue_reading | default:"Continue reading <!--post_title-->" %}
  <a class="fill-card no-hover" href="{{ post.url | relative_url }}" tabindex="-1"><span class="sr-only">{{ text | replace:"<!--post_title-->", post.title }}</span></a>
</article>
