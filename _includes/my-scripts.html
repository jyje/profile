{% comment %}
<!--
Example code for the CloudFlare mail protection script.
CloudFlare will inject this on every page, but due to Hydejack's push state approach to page loading,
it will only run on the initial page.
The snippet below will run the code on every `hy-push-state-load` event instead.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-load', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>
{% endcomment %}

<!-- Duration auto-calculation fallback for GitHub Pages (where plugins don't work) -->
<script>
(function() {
  function calculateDuration(startDate, endDate, lang, threshold) {
    if (!startDate) return '';
    
    var start = new Date(startDate);
    var end = endDate && endDate !== '{}' ? new Date(endDate) : new Date();
    
    if (isNaN(start.getTime()) || isNaN(end.getTime())) return '';
    
    var months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
    
    // Adjust for day difference
    if (end.getDate() < start.getDate()) {
      months--;
    }
    
    // Default threshold to 14 if not provided or invalid
    var thresholdMonths = parseInt(threshold) || 14;
    if (thresholdMonths <= 0) thresholdMonths = 14;
    
    if (lang === 'ko') {
      if (months < thresholdMonths) {
        return months + '개월';
      } else {
        var years = Math.floor(months / 12);
        var remainingMonths = months % 12;
        if (remainingMonths === 0) {
          return years + '년';
        } else {
          return years + '년 ' + remainingMonths + '개월';
        }
      }
    } else {
      if (months < thresholdMonths) {
        return months + ' Month' + (months !== 1 ? 's' : '');
      } else {
        var years = Math.floor(months / 12);
        var remainingMonths = months % 12;
        if (remainingMonths === 0) {
          return years + ' Year' + (years !== 1 ? 's' : '');
        } else {
          return years + ' Year' + (years !== 1 ? 's' : '') + ' ' + remainingMonths + ' Month' + (remainingMonths !== 1 ? 's' : '');
        }
      }
    }
  }
  
  function updateDurations() {
    var elements = document.querySelectorAll('.from-to[data-duration-auto="true"]');
    elements.forEach(function(el) {
      var durationSpan = el.querySelector('.duration');
      if (!durationSpan || durationSpan.textContent.trim() === '()') {
        var startDate = el.getAttribute('data-start-date');
        var endDate = el.getAttribute('data-end-date');
        var lang = el.getAttribute('data-lang') || 'en';
        var threshold = el.getAttribute('data-threshold') || '14';
        
        var calculated = calculateDuration(startDate, endDate, lang, threshold);
        if (calculated) {
          if (!durationSpan) {
            durationSpan = document.createElement('span');
            durationSpan.className = 'duration';
            el.appendChild(durationSpan);
          }
          durationSpan.textContent = '(' + calculated + ')';
        }
      }
    });
  }
  
  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateDurations);
  } else {
    updateDurations();
  }
  
  // Run on push state load (Hydejack navigation)
  var pushState = document.getElementById('_pushState');
  if (pushState) {
    pushState.addEventListener('hy-push-state-load', updateDurations);
  }
})();
</script>
